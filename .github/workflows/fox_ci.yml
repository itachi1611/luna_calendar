name: Flutter Fox CI - Basic ü¶ä

# ======================================================
# üö¶ TRIGGERS
# - Current: run only when PR targets `release`
# - Future: enable push to main / develop if needed
# ======================================================
on:
  # push:
  #   branches: [ main, develop ]
  pull_request:
    branches: [ release ]

  # Manual trigger with flags
  workflow_dispatch:
    inputs:
      use_localizely:
        description: 'Enable Localizely localization download'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  # üåç Localization job (Reusable workflow)
  localizely:
    name: Localization üåç
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.use_localizely == true || github.event_name != 'workflow_dispatch' }}
    uses: ./.github/workflows/localizely.yml
    secrets:
      LOCALIZELY_API_KEY: ${{ secrets.LOCALIZELY_API_KEY }}

  # ü§ñ Android build job
  build_android:
    name: CI ‚Ä¢ Analyze ‚Ä¢ Build ‚Ä¢ Artifact
    runs-on: ubuntu-latest
    needs: localizely

    steps:
      # ==================================================
      # üì• SOURCE CODE
      # ==================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==================================================
      # üì• LOCALIZATION FILES (OPTIONAL)
      # - Retrieved from Localizely job
      # ==================================================
      - name: Download localization artifact
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.use_localizely == true || github.event_name != 'workflow_dispatch' }}
        uses: actions/download-artifact@v4
        with:
          name: localization
          path: lib/l10n

      # ==================================================
      # ‚òï JAVA TOOLCHAIN
      # Required for Android Gradle builds
      # ==================================================
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # ==================================================
      # üê¶ FLUTTER SDK
      # - Flutter version is pinned to ensure CI stability
      # ==================================================
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.4'
          channel: stable
          cache: true

      # ==================================================
      # üì¶ FLUTTER PRECACHE
      #
      # üîπ CURRENT (fast & minimal):
      #   - Android only
      #
      # üîπ FUTURE OPTIONS:
      #   - All platforms: `flutter precache`
      #   - Selective:
      #       --android
      #       --ios
      #       --web
      #       --linux --windows --macos
      # ==================================================
      - name: Precache Flutter (Android only)
        run: flutter precache --android

      # ==================================================
      # üì¶ DEPENDENCIES
      # ==================================================
      - name: Install dependencies
        run: flutter pub get

      # ==================================================
      # üé® CODE FORMAT (TEMPORARILY DISABLED)
      # - Enable when enforcing formatting via CI
      # ==================================================
      # - name: Dart format check
      #   run: dart format . --set-exit-if-changed

      # ==================================================
      # üîç STATIC ANALYSIS
      # ==================================================
      - name: Flutter analyze
        run: flutter analyze

      # ==================================================
      # üß™ TESTS (TEMPORARILY DISABLED)
      # - Enable once test coverage is ready
      # ==================================================
      # - name: Run unit & widget tests
      #   run: flutter test

      # ==================================================
      # üèóÔ∏è BUILD (DEBUG)
      # - Smoke test build to ensure Android compiles
      # ==================================================
      - name: Build debug APK
        run: flutter build apk --debug

      # ==================================================
      # üì§ ARTIFACT
      # - Downloadable from GitHub Actions UI
      # ==================================================
      - name: Upload debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: build/app/outputs/flutter-apk/app-debug.apk

      # ==================================================
      # üöÄ RELEASE FLOW (NOT USED YET)
      #
      # Planned steps:
      # - Build release AAB
      # - App signing
      # - Upload to Google Play
      # ==================================================
      # - name: Build release AAB
      #   run: flutter build appbundle --release
