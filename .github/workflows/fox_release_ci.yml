name: CI - Release ü¶ä

# ======================================================
# üö¶ TRIGGERS
# - Manual trigger with Android build type selection
# - Pull Requests targeting `release`
# ======================================================
on:
  workflow_dispatch:
    inputs:
      android_build_type:
        description: 'APK / AAB'
        required: true
        default: apk
        type: choice
        options:
          - apk
          - appbundle
  #push:
  #  branches: [ release ]
  pull_request:
    branches: [ release ]

permissions:
  contents: read

jobs:
  # ====================================================
  # üèóÔ∏è BUILD JOB (MATRIX)
  # - Android & iOS only (mobile-first)
  # ====================================================
  build:
    name: Build ‚Ä¢ ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # ü§ñ Android
          - platform: android
            os: ubuntu-latest

          # üçé iOS
          - platform: ios
            os: macos-latest

          # üêß Linux (disabled)
          #- platform: linux
          #  os: ubuntu-latest

          # üñ•Ô∏è macOS (disabled)
          #- platform: macos
          #  os: macos-latest

    steps:
      # ==================================================
      # üì• SOURCE CODE
      # ==================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==================================================
      # ‚òï JAVA TOOLCHAIN
      # - Required for Android (Gradle)
      # ==================================================
      - name: Set up Java 17
        if: matrix.platform == 'android' || matrix.platform == 'linux'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # ==================================================
      # üê¶ FLUTTER SDK
      # - Version pinned for CI stability
      # ==================================================
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.4'
          channel: stable
          cache: true

      # ==================================================
      # üì¶ FLUTTER PRECACHE
      # - Platform-specific precache for faster builds
      # ==================================================
      - name: Flutter precache
        run: |
          case "${{ matrix.platform }}" in
            android) flutter precache --android ;;
            ios) flutter precache --ios ;;
            #macos) flutter precache --macos ;;
            #linux) flutter precache --linux ;;
          esac

      # ==================================================
      # üíæ CACHE: PUB (ALL PLATFORMS)
      # - Dart & Flutter dependencies
      # ==================================================
      - name: Cache Flutter Pub
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      # ==================================================
      # üíæ CACHE: GRADLE (ANDROID ONLY)
      # - Android build system dependencies
      # ==================================================
      - name: Cache Gradle (Android only)
        if: matrix.platform == 'android'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # ==================================================
      # üì¶ DEPENDENCIES
      # ==================================================
      - name: Install dependencies
        run: flutter pub get

      # ==================================================
      # üé® CODE FORMAT (OPTIONAL)
      # - Enable when formatting is enforced
      # ==================================================
      # - name: Dart format check
      #   run: dart format . --set-exit-if-changed

      # ==================================================
      # üîç STATIC ANALYSIS
      # ==================================================
      - name: Flutter analyze
        run: flutter analyze

      # ==================================================
      # üß™ TESTS (OPTIONAL)
      # - Enable when test coverage is available
      # ==================================================
      # - name: Run unit & widget tests
      #   run: flutter test

      # ==================================================
      # üèóÔ∏è BUILD
      # - Debug APK (default)
      # - Release AAB via manual trigger
      # ==================================================
      - name: Build
        run: |
          case "${{ matrix.platform }}" in
            android)
              # ü§ñ ANDROID BUILD TYPE
              # - Default: APK (debug)
              # - Manual trigger: AAB (release)
              BUILD_TYPE="${{ github.event.inputs.android_build_type || 'apk' }}"
              if [ "$BUILD_TYPE" = "appbundle" ]; then
                echo "‚ñ∂ Building Android App Bundle (AAB - release)"
                flutter build appbundle --release
              else
                echo "‚ñ∂ Building Android APK (debug)"
                flutter build apk --debug
              fi
              ;;
            ios)
              echo "‚ñ∂ Building iOS (no code signing)"
              flutter build ios --no-codesign
              ;;
          esac

      # ==================================================
      # üì§ ARTIFACTS
      # - Downloadable from GitHub Actions UI
      # ==================================================

      # ü§ñ Android
      - name: Upload Android artifacts üì¶
        if: matrix.platform == 'android'
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ github.event.inputs.android_build_type || 'apk' }}
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/release/*.aab

      # üçé iOS
      - name: Upload iOS artifact üì¶
        if: matrix.platform == 'ios'
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: build/ios/iphoneos/Runner.app

      # ==================================================
      # üöÄ RELEASE FLOW (PLANNED)
      # - Android signing
      # - Play Store upload
      # ==================================================
      # - name: Build release AAB
      #   run: flutter build appbundle --release
